<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mess Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 40px 0;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            background: white;
            color: #4a6cf7;
            border: 2px solid #4a6cf7;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .nav-btn.active {
            background: #4a6cf7;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 108, 247, 0.3);
        }
        
        .nav-btn:hover:not(.active) {
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Common Styles */
        .btn {
            background: #4a6cf7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #3a5ce5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-edit {
            background: #28a745;
        }
        
        .btn-edit:hover {
            background: #218838;
        }
        
        .btn-save {
            background: #17a2b8;
        }
        
        .btn-save:hover {
            background: #138496;
        }
        
        .btn-cancel {
            background: #6c757d;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-search {
            background: #28a745;
        }
        
        .btn-search:hover {
            background: #218838;
        }
        
        .btn-reset {
            background: #6c757d;
        }
        
        .btn-reset:hover {
            background: #5a6268;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error {
            background: #ffecec;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #d32f2f;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        /* Monthly Calculations Styles */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .month-card {
            background: white;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .month-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .month-title {
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .month-date {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .month-content {
            padding: 0;
        }
        
        .costs-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .costs-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
        }
        
        .costs-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cost-value {
            font-weight: 600;
            color: #2c5aa0;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-input:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }
        
        .years-section {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .years-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .year-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a6cf7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .year-card.editing {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        
        .year-title {
            font-weight: 600;
            color: #4a6cf7;
            margin-bottom: 10px;
        }
        
        .year-stats {
            display: flex;
            justify-content: space-between;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .edit-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* Mess Bills Styles */
        .filters-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }
        
        .bill-controls {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .results-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .results-count {
            color: #666;
            margin-top: 5px;
        }
        
        .bills-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .bills-table th {
            background: #4a6cf7;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .bills-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }
        
        .bills-table tr:hover {
            background-color: #f8f9ff;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #ffeaa7;
            color: #e17055;
        }
        
        .status-paid {
            background: #55efc4;
            color: #00b894;
        }
        
        .status-processing {
            background: #81ecec;
            color: #00cec9;
        }
        
        .amount {
            font-weight: 600;
            color: #2c5aa0;
        }
        
        .department-badge {
            background: #e8f4fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4a6cf7;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .visibility-label {
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
            font-weight: 500;
        }
        
        .visibility-visible {
            color: #28a745;
        }
        
        .visibility-hidden {
            color: #dc3545;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Bulk Visibility Update Styles */
        .bulk-visibility-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .bulk-visibility-card h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
        }

        .bulk-visibility-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .bulk-visibility-card label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .bulk-visibility-card select,
        .bulk-visibility-card input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .bulk-visibility-card select:focus,
        .bulk-visibility-card input:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .bulk-visibility-controls {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .bulk-response {
            margin-top: 20px;
            font-size: 14px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            display: none;
            white-space: pre-wrap;
        }
        
        /* Create Monthly Calculation Styles */
        .create-form-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .create-form-card h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
            text-align: center;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a6cf7;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f4ff;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .create-response {
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .navigation {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 200px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .month-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .years-grid {
                grid-template-columns: 1fr;
            }

            .costs-table {
                display: block;
                overflow-x: auto;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .edit-controls {
                flex-direction: column;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .bulk-visibility-grid {
                grid-template-columns: 1fr;
            }

            .bill-controls {
                flex-direction: column;
            }

            .bills-table {
                display: block;
                overflow-x: auto;
            }

            .bills-table th,
            .bills-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mess Management System</h1>
            <p class="subtitle">Complete solution for monthly calculations and mess bills management</p>
        </header>
        
        <div class="navigation">
            <button class="nav-btn active" onclick="showSection('monthlyCalculations')">Monthly Calculations</button>
            <button class="nav-btn" onclick="showSection('messBills')">Mess Bills Management</button>
            <button class="nav-btn" onclick="showSection('createCalculation')">Create Monthly Calculation</button>
        </div>
        
        <!-- Monthly Calculations Section -->
        <div id="monthlyCalculations" class="section active">
            <div class="controls">
                <h2>Monthly Calculations</h2>
                <button id="fetchData" class="btn">Refresh Data</button>
            </div>
            
            <div id="loadingMonthly" class="loading">
                <p>Loading monthly calculations data...</p>
                <div style="margin-top: 20px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #4a6cf7; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>
            
            <div id="errorMonthly" class="error" style="display: none;">
                Error message will appear here
            </div>
            
            <div id="successMonthly" class="success" style="display: none;">
                Success message will appear here
            </div>
            
            <div id="dataContainer" style="display: none;">
                <!-- Monthly calculations data will be populated here -->
            </div>
        </div>
        
        <!-- Mess Bills Management Section -->
        <div id="messBills" class="section">
            <div class="filters-card">
                <h2 style="margin-bottom: 20px;">Search Filters</h2>
                <form id="searchForm">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label class="form-label" for="year_month">Month Year *</label>
                            <input type="text" class="form-input" id="year_month" 
                                   placeholder="e.g., January 2024" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="department">Department</label>
                            <select class="form-select" id="department">
                                <option value="">All Departments</option>
                                <option value="CSE">Computer Science</option>
                                <option value="ECE">Electronics</option>
                                <option value="ME">Mechanical</option>
                                <option value="CE">Civil</option>
                                <option value="EE">Electrical</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="registration_number">Registration Number</label>
                            <input type="text" class="form-input" id="registration_number" 
                                   placeholder="Enter registration number">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="academic_year">Academic Year</label>
                            <select class="form-select" id="academic_year">
                                <option value="">All Years</option>
                                <option value="1">First Year</option>
                                <option value="2">Second Year</option>
                                <option value="3">Third Year</option>
                                <option value="4">Fourth Year</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bill-controls">
                        <button type="button" class="btn btn-reset" onclick="resetFilters()">Reset</button>
                        <button type="submit" class="btn btn-search">Search Bills</button>
                    </div>
                </form>
            </div>

            <!-- Bulk Visibility Update Form -->
            <div class="bulk-visibility-card">
                <h2>Bulk Visibility Update</h2>
                <form id="bulkVisibilityForm">
                    <div class="bulk-visibility-grid">
                        <div class="form-group">
                            <label for="bulk_year_month">Month Year *</label>
                            <input type="text" class="form-input" id="bulk_year_month"
                                   placeholder="e.g., January 2024" required>
                        </div>

                        <div class="form-group">
                            <label for="bulk_department">Department</label>
                            <select class="form-select" id="bulk_department">
                                <option value="">All Departments</option>
                                <option value="CSE">Computer Science</option>
                                <option value="ECE">Electronics</option>
                                <option value="ME">Mechanical</option>
                                <option value="CE">Civil</option>
                                <option value="EE">Electrical</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bulk_academic_year">Academic Year</label>
                            <select class="form-select" id="bulk_academic_year">
                                <option value="">All Years</option>
                                <option value="1">First Year</option>
                                <option value="2">Second Year</option>
                                <option value="3">Third Year</option>
                                <option value="4">Fourth Year</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bulk_show_to_students">Show to Students</label>
                            <select class="form-select" id="bulk_show_to_students" required>
                                <option value="">Select Option</option>
                                <option value="true">Show to Students</option>
                                <option value="false">Hide from Students</option>
                            </select>
                        </div>
                    </div>

                    <div class="bulk-visibility-controls">
                        <button type="button" class="btn btn-reset" onclick="resetBulkForm()">Reset</button>
                        <button type="submit" class="btn btn-search">Update Visibility</button>
                    </div>
                </form>

                <div id="bulkResponse" class="bulk-response"></div>
            </div>

            <div id="loadingBills" class="loading" style="display: none;">
                <p>Loading mess bills data...</p>
                <div style="margin-top: 20px;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #4a6cf7; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>
            
            <div id="errorBills" class="error" style="display: none;">
                Error message will appear here
            </div>
            
            <div id="successBills" class="success" style="display: none;">
                Success message will appear here
            </div>
            
            <div id="resultsContainer" style="display: none;">
                <div class="results-card">
                    <div class="results-header">
                        <div class="results-title">Mess Bills Results</div>
                        <div class="results-count" id="resultsCount">0 bills found</div>
                    </div>
                    <div id="billsTableContainer">
                        <!-- Bills table will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Monthly Calculation Section -->
        <div id="createCalculation" class="section">
            <div class="create-form-card">
                <h2>Create Monthly Calculation</h2>
                <form id="monthlyCalculationForm">
                    <div class="form-section">
                        <div class="form-section-title">Base Costs</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="month_year">Month-Year *</label>
                                <input type="text" class="form-input" id="month_year" name="month_year" 
                                       placeholder="e.g., January 2024" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="grocery_cost">Grocery Cost *</label>
                                <input type="number" step="0.01" class="form-input" id="grocery_cost" name="grocery_cost" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="vegetable_cost">Vegetable Cost *</label>
                                <input type="number" step="0.01" class="form-input" id="vegetable_cost" name="vegetable_cost" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="gas_charges">Gas Charges *</label>
                                <input type="number" step="0.01" class="form-input" id="gas_charges" name="gas_charges" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="total_milk_litres">Total Milk Litres</label>
                                <input type="number" step="0.01" class="form-input" id="total_milk_litres" name="total_milk_litres">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="milk_cost_per_litre">Milk Cost Per Litre</label>
                                <input type="number" step="0.01" class="form-input" id="milk_cost_per_litre" name="milk_cost_per_litre">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="milk_charges_computed">Milk Charges Computed</label>
                                <input type="number" step="0.01" class="form-input" id="milk_charges_computed" name="milk_charges_computed">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="other_costs">Other Costs</label>
                                <input type="number" step="0.01" class="form-input" id="other_costs" name="other_costs">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="deductions_income">Deductions/Income</label>
                                <input type="number" step="0.01" class="form-input" id="deductions_income" name="deductions_income">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="veg_extra_per_day">Veg Extra Per Day</label>
                                <input type="number" step="0.01" class="form-input" id="veg_extra_per_day" name="veg_extra_per_day">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="nonveg_extra_per_day">Non-Veg Extra Per Day</label>
                                <input type="number" step="0.01" class="form-input" id="nonveg_extra_per_day" name="nonveg_extra_per_day">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="total_expenditure">Total Expenditure</label>
                                <input type="number" step="0.01" class="form-input" id="total_expenditure" name="total_expenditure">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="expenditure_after_income">Expenditure After Income</label>
                                <input type="number" step="0.01" class="form-input" id="expenditure_after_income" name="expenditure_after_income">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="mess_fee_per_day">Mess Fee Per Day</label>
                                <input type="number" step="0.01" class="form-input" id="mess_fee_per_day" name="mess_fee_per_day">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title">Per-Year Data</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="first_year_students">First Year Students</label>
                                <input type="number" class="form-input" id="first_year_students" name="first_year_students">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="first_year_days">First Year Days</label>
                                <input type="number" class="form-input" id="first_year_days" name="first_year_days">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="first_year_per_day_amount">First Year Per Day Amount</label>
                                <input type="number" step="0.01" class="form-input" id="first_year_per_day_amount" name="first_year_per_day_amount">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="second_year_students">Second Year Students</label>
                                <input type="number" class="form-input" id="second_year_students" name="second_year_students">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="second_year_days">Second Year Days</label>
                                <input type="number" class="form-input" id="second_year_days" name="second_year_days">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="second_year_per_day_amount">Second Year Per Day Amount</label>
                                <input type="number" step="0.01" class="form-input" id="second_year_per_day_amount" name="second_year_per_day_amount">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="third_year_students">Third Year Students</label>
                                <input type="number" class="form-input" id="third_year_students" name="third_year_students">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="third_year_days">Third Year Days</label>
                                <input type="number" class="form-input" id="third_year_days" name="third_year_days">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="third_year_per_day_amount">Third Year Per Day Amount</label>
                                <input type="number" step="0.01" class="form-input" id="third_year_per_day_amount" name="third_year_per_day_amount">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="fourth_year_students">Fourth Year Students</label>
                                <input type="number" class="form-input" id="fourth_year_students" name="fourth_year_students">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="fourth_year_days">Fourth Year Days</label>
                                <input type="number" class="form-input" id="fourth_year_days" name="fourth_year_days">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="fourth_year_per_day_amount">Fourth Year Per Day Amount</label>
                                <input type="number" step="0.01" class="form-input" id="fourth_year_per_day_amount" name="fourth_year_per_day_amount">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-reset" onclick="resetCreateForm()">Reset</button>
                        <button type="submit" class="btn btn-search">Create Monthly Calculation</button>
                    </div>
                </form>
                
                <div id="createResponse" class="create-response"></div>
            </div>
        </div>

        <!-- Edit Bill Modal -->
        <div id="editBillModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Update Mess Bill</h3>
                    <button class="close-modal" onclick="closeEditModal()">&times;</button>
                </div>
                <form id="editBillForm">
                    <input type="hidden" id="edit_mess_bill_id">
                    <input type="hidden" id="edit_id">
                    
                    <div class="form-group">
                        <label class="form-label" for="edit_status">Status</label>
                        <select class="form-select" id="edit_status" required>
                            <option value="">Select Status</option>
                            <option value="PENDING">PENDING</option>
                            <option value="PAID">PAID</option>
                            <option value="PROCESSING">PROCESSING</option>
                            <option value="CANCELLED">CANCELLED</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit_number_of_days">Number of Days</label>
                        <input type="number" class="form-input" id="edit_number_of_days" 
                               min="1" max="31" placeholder="Enter number of days">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit_latest_order_id">Latest Order ID</label>
                        <input type="text" class="form-input" id="edit_latest_order_id" 
                               placeholder="Enter order ID">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="edit_show_to_students">Show to Students</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="switch">
                                <input type="checkbox" id="edit_show_to_students">
                                <span class="slider round"></span>
                            </label>
                            <span id="show_to_students_label">Hidden from students</span>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-reset" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-search">Update Bill</button>
                    </div>
                </form>
            </div>
        </div>
        
        <footer>
            <p>Mess Management System &copy; 2023</p>
        </footer>
    </div>

    <script>
        // Global helper functions
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return parseFloat(amount).toFixed(2);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Navigation function
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // If showing monthly calculations, fetch data
            if (sectionId === 'monthlyCalculations') {
                fetchMonthlyCalculations();
            }
        }

        // Monthly Calculations functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fetchButton = document.getElementById('fetchData');
            const loadingElementMonthly = document.getElementById('loadingMonthly');
            const errorElementMonthly = document.getElementById('errorMonthly');
            const successElementMonthly = document.getElementById('successMonthly');
            const dataContainer = document.getElementById('dataContainer');
            
            let currentEditId = null;
            let originalData = null;

            // Function to fetch data from the API
            async function fetchMonthlyCalculations() {
                try {
                    // Show loading state
                    loadingElementMonthly.style.display = 'block';
                    errorElementMonthly.style.display = 'none';
                    successElementMonthly.style.display = 'none';
                    dataContainer.style.display = 'none';
                    
                    const response = await fetch('http://localhost:3000/show', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Hide loading state
                    loadingElementMonthly.style.display = 'none';
                    
                    if (data.data && data.data.length > 0) {
                        displayData(data.data);
                        dataContainer.style.display = 'block';
                    } else {
                        displayNoData();
                        dataContainer.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loadingElementMonthly.style.display = 'none';
                    errorElementMonthly.textContent = `Error: ${error.message}`;
                    errorElementMonthly.style.display = 'block';
                }
            }
            
            // Function to display data in cards
            function displayData(calculations) {
                dataContainer.innerHTML = '';
                
                calculations.forEach(calc => {
                    const monthCard = document.createElement('div');
                    monthCard.className = 'month-card';
                    monthCard.id = `month-card-${calc.monthly_base_costs_id}`;
                    
                    // Format the date
                    const createdDate = new Date(calc.created_at);
                    const formattedDate = createdDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Calculate totals for summary
                    const totalStudents = calc.years_data.reduce((sum, year) => sum + (year.total_students || 0), 0);
                    const totalDays = calc.years_data.reduce((sum, year) => sum + (year.total_days || 0), 0);
                    
                    monthCard.innerHTML = `
                        <div class="month-header">
                            <div>
                                <div class="month-title">${calc.month_year}</div>
                                <div class="month-date">Created: ${formattedDate}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Students: ${totalStudents}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Days: ${totalDays}</div>
                                <button class="btn btn-edit" onclick="startEdit('${calc.monthly_base_costs_id}')" style="margin-top: 10px;">
                                    Edit Calculation
                                </button>
                            </div>
                        </div>
                        
                        <div class="month-content">
                            <table class="costs-table">
                                <thead>
                                    <tr>
                                        <th>Cost Category</th>
                                        <th>Amount</th>
                                        <th>Cost Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Grocery Cost</td>
                                        <td class="cost-value">$${formatCurrency(calc.grocery_cost)}</td>
                                        <td>Vegetable Cost</td>
                                        <td class="cost-value">$${formatCurrency(calc.vegetable_cost)}</td>
                                    </tr>
                                    <tr>
                                        <td>Gas Charges</td>
                                        <td class="cost-value">$${formatCurrency(calc.gas_charges)}</td>
                                        <td>Milk Charges</td>
                                        <td class="cost-value">$${formatCurrency(calc.milk_charges_computed)}</td>
                                    </tr>
                                    <tr>
                                        <td>Other Costs</td>
                                        <td class="cost-value">$${formatCurrency(calc.other_costs)}</td>
                                        <td>Deductions/Income</td>
                                        <td class="cost-value">$${formatCurrency(calc.deductions_income)}</td>
                                    </tr>
                                    <tr>
                                        <td>Veg Extra/Day</td>
                                        <td class="cost-value">$${formatCurrency(calc.veg_extra_per_day)}</td>
                                        <td>Non-Veg Extra/Day</td>
                                        <td class="cost-value">$${formatCurrency(calc.nonveg_extra_per_day)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Expenditure</strong></td>
                                        <td class="cost-value" style="color: #e74c3c;"><strong>$${formatCurrency(calc.total_expenditure)}</strong></td>
                                        <td><strong>Expenditure After Income</strong></td>
                                        <td class="cost-value" style="color: #27ae60;"><strong>$${formatCurrency(calc.expenditure_after_income)}</strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3"><strong>Mess Fee Per Day</strong></td>
                                        <td class="cost-value" style="color: #2980b9;"><strong>$${formatCurrency(calc.mess_fee_per_day)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="years-section">
                                <h3 style="margin-bottom: 15px;">Year-wise Data</h3>
                                <div class="years-grid">
                                    ${calc.years_data.map(yearData => `
                                        <div class="year-card">
                                            <div class="year-title">Year ${yearData.year}</div>
                                            <div class="year-stats">
                                                <div class="stat">
                                                    <div class="stat-value">${yearData.total_students || 0}</div>
                                                    <div class="stat-label">Students</div>
                                                </div>
                                                <div class="stat">
                                                    <div class="stat-value">${yearData.total_days || 0}</div>
                                                    <div class="stat-label">Days</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    dataContainer.appendChild(monthCard);
                });
            }

            // Function to start editing a calculation
            window.startEdit = function(baseId) {
                if (currentEditId) {
                    cancelEdit(currentEditId);
                }
                
                currentEditId = baseId;
                const monthCard = document.getElementById(`month-card-${baseId}`);
                if (!monthCard) return;

                // Store original data
                originalData = JSON.parse(JSON.stringify(
                    Array.from(dataContainer.querySelectorAll('.month-card'))
                        .find(card => card.id === `month-card-${baseId}`)
                        .innerHTML
                ));

                // Find the calculation data
                fetch('http://localhost:3000/show', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    const calc = data.data.find(c => c.monthly_base_costs_id == baseId);
                    if (calc) {
                        renderEditForm(calc, monthCard);
                    }
                })
                .catch(error => {
                    console.error('Error fetching calculation details:', error);
                    errorElementMonthly.textContent = 'Error loading calculation details';
                    errorElementMonthly.style.display = 'block';
                });
            };

            // Function to render edit form
            function renderEditForm(calc, monthCard) {
                const formattedDate = new Date(calc.created_at).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                monthCard.innerHTML = `
                    <div class="month-header">
                        <div>
                            <div class="month-title">${calc.month_year} - Editing</div>
                            <div class="month-date">Created: ${formattedDate}</div>
                        </div>
                    </div>
                    
                    <div class="month-content">
                        <table class="costs-table">
                            <thead>
                                <tr>
                                    <th>Cost Category</th>
                                    <th>Amount</th>
                                    <th>Cost Category</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderEditRow('Grocery Cost', 'grocery_cost', calc.grocery_cost, 'Vegetable Cost', 'vegetable_cost', calc.vegetable_cost)}
                                ${renderEditRow('Gas Charges', 'gas_charges', calc.gas_charges, 'Milk Charges', 'milk_charges_computed', calc.milk_charges_computed)}
                                ${renderEditRow('Other Costs', 'other_costs', calc.other_costs, 'Deductions/Income', 'deductions_income', calc.deductions_income)}
                                ${renderEditRow('Veg Extra/Day', 'veg_extra_per_day', calc.veg_extra_per_day, 'Non-Veg Extra/Day', 'nonveg_extra_per_day', calc.nonveg_extra_per_day)}
                                ${renderEditRow('Total Expenditure', 'total_expenditure', calc.total_expenditure, 'Expenditure After Income', 'expenditure_after_income', calc.expenditure_after_income, true)}
                                <tr>
                                    <td colspan="3"><strong>Mess Fee Per Day</strong></td>
                                    <td>
                                        <input type="number" step="0.01" class="edit-input" 
                                               id="mess_fee_per_day" value="${calc.mess_fee_per_day || 0}" 
                                               data-field="mess_fee_per_day">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="years-section">
                            <h3 style="margin-bottom: 15px;">Year-wise Data</h3>
                            <div class="checkbox-group">
                                <strong>Regenerate Mess Bills for Years:</strong>
                                ${calc.years_data.map(year => `
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="year-${year.year}" value="${year.year}" checked>
                                        <label for="year-${year.year}">Year ${year.year}</label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="years-grid">
                                ${calc.years_data.map(yearData => `
                                    <div class="year-card editing">
                                        <div class="year-title">Year ${yearData.year}</div>
                                        <div class="year-stats">
                                            <div class="stat">
                                                <input type="number" class="edit-input" 
                                                       value="${yearData.total_students || 0}"
                                                       data-year="${yearData.year}" data-field="students"
                                                       placeholder="Students">
                                            </div>
                                            <div class="stat">
                                                <input type="number" class="edit-input" 
                                                       value="${yearData.total_days || 0}"
                                                       data-year="${yearData.year}" data-field="days"
                                                       placeholder="Days">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="edit-controls">
                            <button class="btn btn-save" onclick="saveCalculation('${calc.monthly_base_costs_id}')">
                                Save Changes
                            </button>
                            <button class="btn btn-cancel" onclick="cancelEdit('${calc.monthly_base_costs_id}')">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }

            // Helper function to render edit table rows
            function renderEditRow(label1, field1, value1, label2, field2, value2, isBold = false) {
                const boldClass = isBold ? 'style="color: #e74c3c;"' : '';
                return `
                    <tr>
                        <td ${boldClass}>${label1}</td>
                        <td>
                            <input type="number" step="0.01" class="edit-input" 
                                   id="${field1}" value="${value1 || 0}" 
                                   data-field="${field1}">
                        </td>
                        <td ${boldClass}>${label2}</td>
                        <td>
                            <input type="number" step="0.01" class="edit-input" 
                                   id="${field2}" value="${value2 || 0}" 
                                   data-field="${field2}">
                        </td>
                    </tr>
                `;
            }

            // Function to save edited calculation
            window.saveCalculation = async function(baseId) {
                try {
                    const updateData = {
                        base_id: baseId,
                        years_data: []
                    };

                    // Collect base cost fields
                    const baseInputs = document.querySelectorAll('.edit-input[data-field]:not([data-year])');
                    baseInputs.forEach(input => {
                        const field = input.getAttribute('data-field');
                        const value = input.value.trim() === '' ? null : parseFloat(input.value);
                        updateData[field] = value;
                    });

                    // Collect year data
                    const yearInputs = document.querySelectorAll('.edit-input[data-year]');
                    const yearDataMap = {};
                    
                    yearInputs.forEach(input => {
                        const year = input.getAttribute('data-year');
                        const field = input.getAttribute('data-field');
                        const value = input.value.trim() === '' ? 0 : parseInt(input.value);
                        
                        if (!yearDataMap[year]) {
                            yearDataMap[year] = { year: parseInt(year) };
                        }
                        yearDataMap[year][field === 'students' ? 'total_students' : 'total_days'] = value;
                    });

                    // Convert year data map to array
                    updateData.years_data = Object.values(yearDataMap);

                    // Get selected years for bill regeneration
                    const selectedYears = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(checkbox => parseInt(checkbox.value));
                    
                    // Only include selected years in years_data for bill regeneration
                    updateData.years_data = updateData.years_data.filter(year => 
                        selectedYears.includes(year.year)
                    );

                    // Send update request
                    const response = await fetch('http://localhost:3000/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    // Show success message
                    successElementMonthly.textContent = result.message || 'Calculation updated successfully';
                    successElementMonthly.style.display = 'block';

                    // Reset edit state and refresh data
                    currentEditId = null;
                    originalData = null;
                    fetchMonthlyCalculations();

                } catch (error) {
                    console.error('Error updating calculation:', error);
                    errorElementMonthly.textContent = `Error updating calculation: ${error.message}`;
                    errorElementMonthly.style.display = 'block';
                }
            };

            // Function to cancel editing
            window.cancelEdit = function(baseId) {
                if (originalData) {
                    const monthCard = document.getElementById(`month-card-${baseId}`);
                    if (monthCard) {
                        monthCard.innerHTML = originalData;
                    }
                }
                currentEditId = null;
                originalData = null;
            };
            
            // Function to display when no data is available
            function displayNoData() {
                dataContainer.innerHTML = `
                    <div class="no-data">
                        <h3>No Monthly Calculations Found</h3>
                        <p>There are no monthly calculations available in the system.</p>
                        <p>Create a new monthly calculation to get started.</p>
                    </div>
                `;
            }
            
            // Event listener for the fetch button
            fetchButton.addEventListener('click', fetchMonthlyCalculations);
            
            // Fetch data on page load for monthly calculations
            fetchMonthlyCalculations();
        });

        // Mess Bills functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('searchForm');
            const loadingElementBills = document.getElementById('loadingBills');
            const errorElementBills = document.getElementById('errorBills');
            const successElementBills = document.getElementById('successBills');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');
            const billsTableContainer = document.getElementById('billsTableContainer');
            const editBillModal = document.getElementById('editBillModal');
            const editBillForm = document.getElementById('editBillForm');

            // Handle search form submission
            searchForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await searchMessBills();
            });

            // Function to search mess bills
            async function searchMessBills() {
                try {
                    const searchData = {
                        year_month: document.getElementById('year_month').value.trim(),
                        department: document.getElementById('department').value,
                        registration_number: document.getElementById('registration_number').value.trim(),
                        academic_year: document.getElementById('academic_year').value
                    };

                    if (!searchData.year_month) {
                        errorElementBills.textContent = 'Month Year is required';
                        errorElementBills.style.display = 'block';
                        return;
                    }

                    // Show loading state
                    loadingElementBills.style.display = 'block';
                    errorElementBills.style.display = 'none';
                    successElementBills.style.display = 'none';
                    resultsContainer.style.display = 'none';

                    const response = await fetch('http://localhost:3000/fetchstudentsmessbill', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(searchData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Fetched bills data:', data); // Debug log

                    // Hide loading state
                    loadingElementBills.style.display = 'none';

                    if (data.data && data.data.length > 0) {
                        displayBills(data.data);
                        resultsCount.textContent = `${data.count} bills found for ${searchData.year_month}`;
                        resultsContainer.style.display = 'block';
                    } else {
                        displayNoBills();
                        resultsCount.textContent = 'No bills found';
                        resultsContainer.style.display = 'block';
                    }

                } catch (error) {
                    console.error('Error fetching mess bills:', error);
                    loadingElementBills.style.display = 'none';
                    errorElementBills.textContent = `Error: ${error.message}`;
                    errorElementBills.style.display = 'block';
                }
            }

            // Function to display bills in table - FIXED VERSION
            function displayBills(bills) {
                billsTableContainer.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="bills-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Registration No.</th>
                                    <th>Department</th>
                                    <th>Academic Year</th>
                                    <th>Days</th>
                                    <th>Fee/Day</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Show to Students</th>
                                    <th>Order ID</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bills.map(bill => {
                                    // Use the correct ID field from the API response
                                    const billId = bill.id || bill.mess_bill_id;
                                    console.log('Processing bill:', { 
                                        id: bill.id, 
                                        mess_bill_id: bill.mess_bill_id,
                                        billId: billId,
                                        show_to_students: bill.show_to_students 
                                    });
                                    
                                    return `
                                    <tr>
                                        <td>${bill.name}</td>
                                        <td>${bill.registration_number}</td>
                                        <td><span class="department-badge">${bill.department}</span></td>
                                        <td>Year ${bill.academic_year}</td>
                                        <td>${bill.number_of_days || 30}</td>
                                        <td>$${formatCurrency(bill.mess_fee_per_day)}</td>
                                        <td class="amount">$${formatCurrency(bill.total_amount)}</td>
                                        <td>
                                            <span class="status-badge status-${bill.status.toLowerCase()}">
                                                ${bill.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; flex-direction: column; align-items: center;">
                                                <label class="switch">
                                                    <input type="checkbox" class="show-to-students-toggle" 
                                                           data-bill-id="${billId}" 
                                                           ${bill.show_to_students ? 'checked' : ''}
                                                           onchange="toggleShowToStudents('${billId}', this.checked)">
                                                    <span class="slider round"></span>
                                                </label>
                                                <div class="visibility-label ${bill.show_to_students ? 'visibility-visible' : 'visibility-hidden'}">
                                                    ${bill.show_to_students ? 'Visible' : 'Hidden'}
                                                </div>
                                            </div>
                                        </td>
                                        <td>${bill.latest_order_id || 'N/A'}</td>
                                        <td>${formatDate(bill.updated_at || bill.created_at)}</td>
                                        <td>
                                            <button class="btn btn-edit" onclick="openEditModal(
                                                '${bill.mess_bill_id}',
                                                '${bill.status}',
                                                '${bill.number_of_days || ''}',
                                                '${bill.latest_order_id || ''}',
                                                ${bill.show_to_students},
                                                '${billId}'
                                            )">
                                                Edit
                                            </button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Function to toggle show_to_students - FIXED VERSION
            window.toggleShowToStudents = async function(messBillId, showToStudents) {
                try {
                    console.log('Toggle function called with:', {
                        messBillId: messBillId,
                        showToStudents: showToStudents,
                        typeOfId: typeof messBillId
                    });

                    // Validate ID
                    if (!messBillId || messBillId === 'undefined' || messBillId === 'null') {
                        console.error('Invalid bill ID received:', messBillId);
                        throw new Error('Invalid bill ID');
                    }

                    // Ensure ID is a number
                    const billId = parseInt(messBillId);
                    if (isNaN(billId)) {
                        console.error('Bill ID is not a number:', messBillId);
                        throw new Error('Invalid bill ID format');
                    }

                    const requestData = {
                        id: billId,
                        show_to_students: Boolean(showToStudents)
                    };

                    console.log('Sending request to API:', requestData);

                    const response = await fetch('http://localhost:3000/updatesshowmessbilltostudents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    // Show success message
                    successElementBills.textContent = result.message || `Bill ${showToStudents ? 'shown to' : 'hidden from'} students successfully`;
                    successElementBills.style.display = 'block';
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successElementBills.style.display = 'none';
                    }, 3000);

                    // Update the visibility label
                    const toggle = document.querySelector(`input[data-bill-id="${messBillId}"]`);
                    if (toggle) {
                        const label = toggle.closest('td').querySelector('.visibility-label');
                        if (label) {
                            label.textContent = showToStudents ? 'Visible' : 'Hidden';
                            label.className = `visibility-label ${showToStudents ? 'visibility-visible' : 'visibility-hidden'}`;
                        }
                    }

                } catch (error) {
                    console.error('Error updating show_to_students:', error);
                    errorElementBills.textContent = `Error updating visibility: ${error.message}`;
                    errorElementBills.style.display = 'block';
                    
                    // Revert the toggle if there was an error
                    const toggle = document.querySelector(`input[data-bill-id="${messBillId}"]`);
                    if (toggle) {
                        toggle.checked = !showToStudents; // Revert to previous state
                        const label = toggle.closest('td').querySelector('.visibility-label');
                        if (label) {
                            label.textContent = !showToStudents ? 'Visible' : 'Hidden';
                            label.className = `visibility-label ${!showToStudents ? 'visibility-visible' : 'visibility-hidden'}`;
                        }
                    }
                }
            };

            // Function to display no bills message
            function displayNoBills() {
                billsTableContainer.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">📄</div>
                        <h3>No Mess Bills Found</h3>
                        <p>No mess bills match your search criteria.</p>
                        <p>Try adjusting your filters or check the month year format.</p>
                    </div>
                `;
            }

            // Function to reset filters
            window.resetFilters = function() {
                document.getElementById('searchForm').reset();
                resultsContainer.style.display = 'none';
                errorElementBills.style.display = 'none';
                successElementBills.style.display = 'none';
            };

            // Function to open edit modal
            window.openEditModal = function(messBillId, status, number_of_days, latest_order_id, show_to_students, id) {
                document.getElementById('edit_mess_bill_id').value = messBillId;
                document.getElementById('edit_id').value = id;
                document.getElementById('edit_status').value = status;
                document.getElementById('edit_number_of_days').value = number_of_days;
                document.getElementById('edit_latest_order_id').value = latest_order_id;
                document.getElementById('edit_show_to_students').checked = show_to_students;
                
                // Update label text
                const label = document.getElementById('show_to_students_label');
                label.textContent = show_to_students ? 'Visible to students' : 'Hidden from students';
                
                editBillModal.style.display = 'block';
            };

            // Function to close edit modal
            window.closeEditModal = function() {
                editBillModal.style.display = 'none';
            };

            // Handle edit form submission
            editBillForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const mess_bill_id = document.getElementById('edit_mess_bill_id').value;
                const id = document.getElementById('edit_id').value;
                const status = document.getElementById('edit_status').value;
                const number_of_days = document.getElementById('edit_number_of_days').value;
                const latest_order_id = document.getElementById('edit_latest_order_id').value;
                const show_to_students = document.getElementById('edit_show_to_students').checked;
                
                try {
                    // Update mess bill details
                    const updateData = {
                        mess_bill_id: mess_bill_id,
                        status: status,
                        number_of_days: number_of_days ? parseInt(number_of_days) : undefined,
                        latest_order_id: latest_order_id || undefined
                    };

                    const response = await fetch('http://localhost:3000/upadatemessbill', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Update show_to_students separately
                    const showResponse = await fetch('http://localhost:3000/updatesshowmessbilltostudents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: parseInt(id),
                            show_to_students: show_to_students
                        })
                    });

                    if (!showResponse.ok) {
                        throw new Error(`HTTP error! status: ${showResponse.status}`);
                    }

                    const result = await response.json();
                    const showResult = await showResponse.json();

                    // Show success message
                    successElementBills.textContent = 'Mess bill updated successfully';
                    successElementBills.style.display = 'block';

                    // Close modal
                    closeEditModal();

                    // Refresh search results
                    await searchMessBills();

                } catch (error) {
                    console.error('Error updating mess bill:', error);
                    errorElementBills.textContent = `Error updating mess bill: ${error.message}`;
                    errorElementBills.style.display = 'block';
                }
            });

            // Handle bulk visibility form submission
            const bulkVisibilityForm = document.getElementById('bulkVisibilityForm');
            const bulkResponse = document.getElementById('bulkResponse');

            bulkVisibilityForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateBulkVisibility();
            });

            // Function to update bulk visibility
            async function updateBulkVisibility() {
                try {
                    const bulkData = {
                        year_month: document.getElementById('bulk_year_month').value.trim(),
                        department: document.getElementById('bulk_department').value,
                        academic_year: document.getElementById('bulk_academic_year').value,
                        show_to_students: document.getElementById('bulk_show_to_students').value
                    };

                    if (!bulkData.year_month) {
                        bulkResponse.textContent = 'Month Year is required';
                        bulkResponse.style.display = 'block';
                        bulkResponse.style.color = '#d32f2f';
                        return;
                    }

                    if (!bulkData.show_to_students) {
                        bulkResponse.textContent = 'Show to Students option is required';
                        bulkResponse.style.display = 'block';
                        bulkResponse.style.color = '#d32f2f';
                        return;
                    }

                    // Show loading state
                    bulkResponse.textContent = 'Updating visibility...';
                    bulkResponse.style.display = 'block';
                    bulkResponse.style.color = '#666';

                    const response = await fetch('http://localhost:3000/bulkupdatemessbillvisibility', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bulkData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    // Show success message
                    bulkResponse.textContent = result.message || `Successfully updated ${result.updated_count || 0} bills`;
                    bulkResponse.style.color = '#2e7d32';

                    // Refresh search results if they exist
                    const resultsContainer = document.getElementById('resultsContainer');
                    if (resultsContainer.style.display !== 'none') {
                        await searchMessBills();
                    }

                } catch (error) {
                    console.error('Error updating bulk visibility:', error);
                    bulkResponse.textContent = `Error: ${error.message}`;
                    bulkResponse.style.display = 'block';
                    bulkResponse.style.color = '#d32f2f';
                }
            }

            // Function to reset bulk form
            window.resetBulkForm = function() {
                document.getElementById('bulkVisibilityForm').reset();
                bulkResponse.style.display = 'none';
            };
            
            // Create Monthly Calculation functionality
            const createForm = document.getElementById('monthlyCalculationForm');
            const createResponse = document.getElementById('createResponse');
            
            createForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(createForm);
                const data = {};
                
                formData.forEach((value, key) => {
                    if (value !== '') data[key] = Number(value) ? parseFloat(value) : value;
                });
                
                try {
                    const res = await fetch('http://localhost:3000/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await res.json();
                    
                    if (res.ok) {
                        createResponse.textContent = result.message || 'Monthly calculation created successfully!';
                        createResponse.style.color = '#2e7d32';
                        createForm.reset();
                    } else {
                        createResponse.textContent = result.error || 'Failed to create calculation.';
                        createResponse.style.color = '#d32f2f';
                    }
                } catch (error) {
                    createResponse.textContent = 'Error connecting to server.';
                    createResponse.style.color = '#d32f2f';
                    console.error(error);
                }
            });
            
            // Function to reset create form
            window.resetCreateForm = function() {
                document.getElementById('monthlyCalculationForm').reset();
                createResponse.textContent = '';
            };

            // Close modal when clicking outside
            editBillModal.addEventListener('click', function(e) {
                if (e.target === editBillModal) {
                    closeEditModal();
                }
            });
        });

        // Add CSS for loading animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>