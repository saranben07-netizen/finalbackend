<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cashfree Sandbox UPI/GPay</title>
<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
<style>
    body { font-family: Arial, sans-serif; padding: 50px; background-color: #f0f0f0; }
    input, button { padding: 12px 24px; font-size: 16px; margin: 10px 0; }
    button { background-color: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
</style>
</head>
<body>
<h2>Cashfree UPI / GPay Sandbox Test</h2>
<p>Enter Student ID and Year-Month to create the order:</p>

<input type="text" id="studentIdInput" placeholder="Enter Student ID" />
<input type="text" id="yearMonthInput" placeholder="Enter Year-Month (YYYY-MM)" />
<button id="payBtn">Pay (Test)</button>

<script>
const cashfree = Cashfree({ mode: "sandbox" });

document.getElementById("payBtn").addEventListener("click", async () => {
    try {
        const studentId = document.getElementById("studentIdInput").value.trim();
        const yearMonth = document.getElementById("yearMonthInput").value.trim();

        if (!studentId || !yearMonth) {
            alert("Please enter both Student ID and Year-Month");
            return;
        }

        // Call backend to create order
        const res = await fetch("http://localhost:3000/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                student_id: studentId, 
                year_month: yearMonth,
                student_name: "Test Student",
                student_email: "test@example.com", 
                student_phone: "9999999999"
            })
        });

        const data = await res.json();

        // Debug: Log the entire response to see the actual structure
        console.log("Backend response:", data);

        // FIX: Extract payment_session_id from the nested structure
        const paymentSessionId = data.payment_session_id || 
                               (data.cashfree_response && data.cashfree_response.payment_session_id) ||
                               (data.response && data.response.payment_session_id);

        if (!paymentSessionId) {
            alert("Failed to get payment session ID from backend.");
            console.error("Available data:", data);
            return;
        }

        console.log("Payment Session ID:", paymentSessionId);

        // Open Cashfree Checkout
        cashfree.checkout({
            paymentSessionId: paymentSessionId,
            redirectTarget: "_self"
        });

    } catch (err) {
        console.error("Error initiating payment:", err);
        alert("Error initiating payment. Check console.");
    }
});
</script>
</body>``
</html>